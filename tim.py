import streamlit as st
import streamlit.components.v1 as components
import pandas as pd
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os
from datetime import datetime
import time
import pytz
from collections import Counter
import base64

# ================= 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö =================
ORDER_CSV = 'order_history.csv'
MENU_CSV = 'menu_data.csv'
TABLES_CSV = 'tables_data.csv'
CONTACT_CSV = 'contact_data.csv'
QUEUE_CSV = 'queue_data.csv'
FEEDBACK_CSV = 'feedback_data.csv'
BANNER_FOLDER = 'banner_images'

KITCHEN_LIMIT = 10  # ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á 10

if not os.path.exists(BANNER_FOLDER): os.makedirs(BANNER_FOLDER)


# ================= 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =================

def get_thai_time():
    tz = pytz.timezone('Asia/Bangkok')
    return datetime.now(tz)


def load_orders():
    cols = ["‡πÄ‡∏ß‡∏•‡∏≤", "‡πÇ‡∏ï‡πä‡∏∞", "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"]
    if not os.path.exists(ORDER_CSV):
        pd.DataFrame(columns=cols).to_csv(ORDER_CSV, index=False)
    try:
        df = pd.read_csv(ORDER_CSV)
        if list(df.columns) != cols: return pd.DataFrame(columns=cols)
        return df
    except:
        return pd.DataFrame(columns=cols)


def load_queue():
    if not os.path.exists(QUEUE_CSV):
        pd.DataFrame(columns=["queue_id", "customer_name", "timestamp"]).to_csv(QUEUE_CSV, index=False)
    return pd.read_csv(QUEUE_CSV)


def add_to_queue(name):
    df = load_queue()
    if not df.empty and name in df['customer_name'].values:
        return df[df['customer_name'] == name].iloc[0]['queue_id']
    last_id = 100
    if not df.empty:
        try:
            last_id = int(str(df.iloc[-1]['queue_id']).split('-')[1])
        except:
            pass
    new_id = f"Q-{last_id + 1}"
    new_data = {"queue_id": new_id, "customer_name": name, "timestamp": get_thai_time().strftime("%Y-%m-%d %H:%M:%S")}
    pd.concat([df, pd.DataFrame([new_data])], ignore_index=True).to_csv(QUEUE_CSV, index=False)
    return new_id


def pop_queue():
    df = load_queue()
    if not df.empty:
        df.iloc[1:].to_csv(QUEUE_CSV, index=False)


def save_order(data):
    df = load_orders()
    mask = (df['‡πÇ‡∏ï‡πä‡∏∞'] == data['‡πÇ‡∏ï‡πä‡∏∞']) & (df['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] == 'waiting')
    if mask.any():
        idx = df.index[mask][0]
        # ‡∏ó‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤
        df.at[idx, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£'] = f"{df.at[idx, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£']}, {data['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£']}"
        try:
            old_p = float(df.at[idx, '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'])
        except:
            old_p = 0.0
        df.at[idx, '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'] = old_p + float(data['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'])
        df.to_csv(ORDER_CSV, index=False)
        return "merged"
    else:
        pd.concat([df, pd.DataFrame([data])], ignore_index=True).to_csv(ORDER_CSV, index=False)
        return "new"


def get_image_base64(path):
    with open(path, "rb") as f: return f"data:image/png;base64,{base64.b64encode(f.read()).decode()}"


# ================= 3. UI & CSS =================
st.set_page_config(page_title="TimNoi Shabu", page_icon="üç≤", layout="wide")

st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;500;700&display=swap');
    html, body, [class*="css"] { font-family: 'Sarabun', sans-serif; background-color: #FDFBF7; }
    .stButton>button { border-radius: 8px; font-weight: bold; background-color: #8D6E63; color: white; border: none; height: 50px; }
    .stButton>button:hover { background-color: #6D4C41; color: #FFECB3; }
    .queue-box { background: linear-gradient(135deg, #3E2723 0%, #5D4037 100%); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 20px; }
</style>
""", unsafe_allow_html=True)

# ================= 4. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• & State =================
if 'page' not in st.session_state: st.session_state.page = 'menu'
if 'app_mode' not in st.session_state: st.session_state.app_mode = 'customer'
if 'my_queue_id' not in st.session_state: st.session_state.my_queue_id = None
if 'basket' not in st.session_state: st.session_state.basket = []

orders_df = load_orders()
waiting_orders = orders_df[orders_df['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] == 'waiting']
kitchen_load = len(waiting_orders)
queue_df = load_queue()

# ================= 5. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) =================
c_logo, c_name, c_menu = st.columns([1.3, 2, 0.5])
with c_logo:
    if os.path.exists("logo.png"): st.image("logo.png", width=320)
with c_name:
    st.markdown(f"""
        <div style="display: flex; flex-direction: column; justify-content: center; height: 220px;">
            <h1 style='color:#3E2723; font-size:50px; margin:0;'>TimNoi Shabu</h1>
            <p style='color:#8D6E63; font-size:20px; font-weight:bold;'>‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏π‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏≤</p>
            <div style='margin-top:15px; border-top: 2px solid #D7CCC8; padding-top:10px;'>
                <p style='color:#5D4037; font-size:16px; margin:0;'>üïí ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: 00:00 - 23:59 ‡∏ô.</p>
                <p style='color:#5D4037; font-size:16px; margin:0;'>üìû ‡πÇ‡∏ó‡∏£: 064-448-55549</p>
            </div>
        </div>
    """, unsafe_allow_html=True)
with c_menu:
    with st.popover("‚ò∞"):
        if st.button("üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", use_container_width=True): st.session_state.app_mode = 'customer'; st.rerun()
        if st.button("‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô", use_container_width=True): st.session_state.app_mode = 'admin_login'; st.rerun()

st.divider()

# ================= 6. Controller =================

if st.session_state.app_mode == 'admin_login':
    pw = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
    if pw == "090090op": st.session_state.app_mode = 'admin_dashboard'; st.rerun()

elif st.session_state.app_mode == 'admin_dashboard':
    tabs = st.tabs(["üë®‚Äçüç≥ ‡∏Ñ‡∏£‡∏±‡∏ß (Auto)", "üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å", "üìù ‡πÄ‡∏°‡∏ô‡∏π", "üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", "üí¨ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß"])

    with tabs[0]:  # ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥
        st.markdown(f"**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ß: {kitchen_load}/{KITCHEN_LIMIT}**")
        if kitchen_load > 0:
            for idx, row in waiting_orders.iterrows():
                with st.container(border=True):
                    c1, c2 = st.columns([3, 1])
                    with c1:
                        st.write(f"**{row['‡πÇ‡∏ï‡πä‡∏∞']}** | {row['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤']} | üí∞ {float(row['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']):,.2f} ‡∏ö.")
                        st.caption(row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£'])
                    with c2:
                        if st.button("‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß", key=f"p_{idx}"):
                            orders_df.at[idx, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] = 'paid';
                            orders_df.to_csv(ORDER_CSV, index=False);
                            st.rerun()
                        if st.button("‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", key=f"can_{idx}"):
                            orders_df.at[idx, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] = 'cancelled';
                            orders_df.to_csv(ORDER_CSV, index=False);
                            st.rerun()
        else:
            st.info("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á")
        time.sleep(10);
        st.rerun()

    with tabs[1]:  # ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞
        st.write("üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£")
        # (‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å...)

# === üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer) ===
else:
    # --- üö¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á 10 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
    show_booking_ui = False
    if kitchen_load >= KITCHEN_LIMIT:
        if not st.session_state.my_queue_id:
            show_booking_ui = True
        else:
            try:
                my_pos = queue_df['queue_id'].tolist().index(st.session_state.my_queue_id)
                if my_pos == 0 and kitchen_load < KITCHEN_LIMIT:
                    show_booking_ui = False
                else:
                    st.markdown(f"""<div class="queue-box"><h2>üé´ ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ {st.session_state.my_queue_id}</h2>
                    <p>‡∏£‡∏≠‡∏≠‡∏µ‡∏Å {my_pos} ‡∏Ñ‡∏¥‡∏ß‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p></div>""", unsafe_allow_html=True)
                    if st.button("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß"): st.rerun()
                    st.stop()
            except:
                st.session_state.my_queue_id = None; st.rerun()

    if show_booking_ui:
        st.error(f"üö´ ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏ï‡πá‡∏° ({kitchen_load}/{KITCHEN_LIMIT}) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå")
        q_name = st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå")
        st.caption("‚ÑπÔ∏è ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ")  # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏•‡πá‡∏Å‡πÜ
        if st.button("üé´ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß / ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏î‡∏¥‡∏°", type="primary", use_container_width=True):
            if q_name:
                st.session_state.my_queue_id = add_to_queue(q_name); st.rerun()
            else:
                st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏ß‡πâ")  # ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠
        st.stop()

    # --- üçú ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ ---
    st.subheader("üõí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£")
    c_t, c_c = st.columns(2)
    with c_t:
        table_no = st.selectbox("üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞", ["‡πÇ‡∏ï‡πä‡∏∞ 1", "‡πÇ‡∏ï‡πä‡∏∞ 2", "‡πÇ‡∏ï‡πä‡∏∞ 3", "‡πÇ‡∏ï‡πä‡∏∞ 4", "‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô"])
    with c_c:
        cust_name = st.text_input("üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ...")
        st.caption("‚ÑπÔ∏è ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ")  # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ï‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠

    # ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á
    if not cust_name:
        st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏ß‡πâ")
        st.stop()

    # (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞ ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...)
    st.divider()
    st.info("‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö")
    # ...